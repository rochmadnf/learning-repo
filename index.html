<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracking Realtime &mdash; Rochmad</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <style>
    body{
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map">

  </div>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <!--<script src="/files/custom.js"></script>-->
  <script>
    window.addEventListener('load', (e) => {
    //   document.querySelector('img[alt=""]').remove();
      const from_who = prompt("Siapa Kamu ?")
      const map = L.map('map').setView([-0.9109409, 119.8632198], 18);
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      });
      osm.addTo(map);

      if (!navigator.geolocation) {
        alert("Browser kamu tidak support")
      }else {
        setInterval(() => {
              navigator.geolocation.getCurrentPosition(getPosition)
          }, 1000);
      }

      let marker, circle, oldLat, oldLong;
      const user_id = Math.floor(Math.random() * 10000);

      function getPosition(pos){
        // console.log(pos);
        const lat = pos.coords.latitude;
        const long = pos.coords.longitude;
        const accuracy = pos.coords.accuracy;

        if (oldLat != lat || oldLong != long) {
          if(marker) {
            map.removeLayer(marker)
          }

          if(circle) {
            map.removeLayer(circle)
          }

          marker = L.marker([lat, long])
          circle = L.circle([lat, long], {radius: accuracy})

          const featureGroup = L.featureGroup([marker, circle]).addTo(map)

          map.fitBounds(featureGroup.getBounds())

          // store data to db
          fetch(`${location.protocol}//${location.host}/func/store.php`,
          {
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            credentials: 'same-origin',
            method: 'post',
            body: JSON.stringify({
              "user_id": user_id,
              "latitude": lat,
              "longitude": long,
              "accuracy": accuracy,
              "from_who": from_who,
            }),
          }).then(res => res.json()).then(data => console.clear()).catch(err => console.log(err));
          oldLat = lat
          oldLong = long
        }
      }
    });
  </script>
</body>
</html>